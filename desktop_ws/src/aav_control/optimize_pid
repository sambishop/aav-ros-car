#!/usr/bin/python3

import os
from scipy.optimize import minimize
import subprocess
import sys

cte_file_num = 1

def run(args):
    subprocess.call(args, shell=True)

def calculate_measure(cte_filename):
    num_values = 0
    sum = 0
    with open(cte_filename, 'r') as f:
        for line in f:
            if line.startswith('data:') and not line.startswith('data: nan'):
                num_values += 1
                sum += abs(float(line.split(' ')[1]))
    print(sum, num_values, sum / num_values)
    return sum / num_values

def format_cte_file(p, i, d, n):
    cte_filename = '{0:05d}'.format(cte_file_num)
    cte_filename += '_p_{0:0f}_i_{1:0f}_d_{2:0f}'.format(p, i, d)
    cte_filename += '_{0:02d}'.format(n)
    cte_filename += '.cte'
    return cte_filename

def run_sim(p, i, d, cte_filename):
    run('./run_sim {0} {1} {2} {3}'.format(p, i, d, cte_filename))

def run_sims(x):
    p, i, d = x[0], x[1], x[2]
    total = 0
    for n in range(1, 11):
        cte_filename = format_cte_file(p, i, d, n)
        run_sim(p, i, d, cte_filename)
        total += calculate_measure(cte_filename)
    global cte_file_num
    cte_file_num += 1
    mean = total / 10
    print('*********** mean = %f ***********', mean)

x0 = [float(sys.argv[1]), float(sys.argv[2]), float(sys.argv[3])]
res = minimize(run_sims, x0, method='nelder-mead')
print(res.x)

